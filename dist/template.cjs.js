"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(r):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],n=!0,o=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(o)throw a}}return r}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}Object.defineProperty(exports,"__esModule",{value:!0});var _pathDel="/",_pathIndex=/\[([0-9]+)\]/m,_commentNodeHint="comment()",_textNodeHint="text()",Path=function(){function o(){_classCallCheck(this,o)}return _createClass(o,null,[{key:"_checkNodeType",value:function(e){if(!e||void 0===e.nodeType)throw new TypeError("argument provided is not a Node","path.js")}},{key:"_nodeChildComments",value:function(e){return o._checkNodeType(e),null!==e.childNodes&&e.hasChildNodes()?_toConsumableArray(e.childNodes).filter(function(e){return e.nodeType===Node.COMMENT_NODE}):[]}},{key:"_nodeChildTexts",value:function(e){return o._checkNodeType(e),null!==e.childNodes&&e.hasChildNodes()?_toConsumableArray(e.childNodes).filter(function(e){return e.nodeType===Node.TEXT_NODE}):[]}},{key:"_nodeSiblings",value:function(t){return o._checkNodeType(t),null===t.parentNode?[]:_toConsumableArray(t.parentNode.childNodes).filter(function(e){return t.nodeType===e.nodeType&&(t.nodeType===Node.ELEMENT_NODE?t.tagName===e.tagName:t.nodeType===Node.COMMENT_NODE||t.nodeType===Node.TEXT_NODE)})}},{key:"fromNode",value:function(e){var t;if(o._checkNodeType(e),e.nodeType===Node.ELEMENT_NODE)t=e.tagName.toLowerCase();else if(e.nodeType===Node.COMMENT_NODE)t=_commentNodeHint;else{if(e.nodeType!==Node.TEXT_NODE)return"";t=_textNodeHint}if(e.id&&""!==e.id)t+="#".concat(e.id);else{var r=o._nodeSiblings(e);1<r.length&&(t+="[".concat(r.indexOf(e),"]"))}return e.parentNode?"".concat(o.fromNode(e.parentNode)).concat(_pathDel).concat(t):t}},{key:"findNode",value:function(e,t){o._checkNodeType(t);var r=e.split(_pathDel);r.shift();var n=t;return r.forEach(function(e){if(n){var t=0;_pathIndex.test(e)&&(t=Array.from(_pathIndex.exec(e))[0][1],e=e.replace(_pathIndex,"")),n=(e.includes(_commentNodeHint)?o._nodeChildComments(n):e.includes(_textNodeHint)?o._nodeChildTexts(n):n.querySelectorAll(e))[t]}}),n}}]),o}(),TNodeType={ATTRIBUTE:"attr",INTERPOLATION:"interpolation",EMPTY:"empty"},_attrRe=/\s(\S+)\=[\"\']<!--slot\(([0-9]+)\)-->[\"\']/gm,_interRe=/slot\(([0-9]+)\)/gm,_protectedAttrs=["id"],TNode=function(){function t(e){if(_classCallCheck(this,t),!e||void 0===e.nodeType)throw new TypeError("argument provided is not a Node","tnode.js");this.path=Path.fromNode(e),this.fields=new Map,this._node=e,this._outer="",this._type=TNodeType.EMPTY,this._initParsing()}return _createClass(t,[{key:"_getOuter",value:function(){this._outer=this._node.cloneNode(!1).outerHTML}},{key:"_getType",value:function(){this._node.nodeType===Node.COMMENT_NODE?(_interRe.test(this._node.data)&&(this._type=TNodeType.INTERPOLATION),_interRe.lastIndex=0):this._node.nodeType===Node.ELEMENT_NODE?(_attrRe.test(this._outer)&&(this._type=TNodeType.ATTRIBUTE),_attrRe.lastIndex=0):this._type=TNodeType.EMPTY}},{key:"_initParsing",value:function(){this._getOuter(),this._getType(),this.isAttr?this._parseAttr():this.isInterpolation&&this._parseInter()}},{key:"_parseAttr",value:function(){var n=this;if(!this.isAttr)throw new TypeError("TNode referenced has not any attribute","tnode.js");var e=Array.from(this._outer.matchAll(_attrRe));_attrRe.lastIndex=0,e.forEach(function(e){var t=e[1],r=parseInt(e[2]);if(_protectedAttrs.includes(t))throw new Error("Node attribute '".concat(t,"' can not be dynamic"),"tnode.js");n.fields.set(r,{attr:t,value:null})})}},{key:"_parseInter",value:function(){var n=this;if(!this.isInterpolation)throw new TypeError("TNode referenced is not an interpolation","tnode.js");var e=Array.from(this._node.data.matchAll(_interRe));_interRe.lastIndex=0,e.forEach(function(e){var t=parseInt(e[1]),r=n._node.nextSibling?Path.fromNode(n._node.nextSibling):null;n.fields.set(t,{nextElem:r,value:null})})}},{key:"_renderAttr",value:function(t){if(!this.isAttr)throw new TypeError("TNode referenced has not any attribute","tnode.js");this.fields.forEach(function(e){return t.setAttribute(e.attr,e.value)})}},{key:"_renderInter",value:function(t){if(!this.isInterpolation)throw new TypeError("TNode referenced is not an interpolation","tnode.js");var e=_slicedToArray(Array.from(this.fields.entries())[0],2),r=e[0],n=e[1],o=document.createElement("div");o.innerHTML=n.value;var a=n.nextElem?Path.findNode(n.nextElem,t.getRootNode()):null;this._clearInter(t,a),Array.from(o.childNodes).forEach(function(e){a?t.parentNode.insertBefore(e,a):t.parentNode.appendChild(e)}),a&&(n.nextElem=Path.fromNode(a),this.fields.set(r,n))}},{key:"_clearInter",value:function(e,t){if(!e||void 0===e.nodeType)throw new TypeError("The argument provided is not a Node","tnode.js");for(var r=t,n=e.nextSibling;n&&!n.isEqualNode(r);){var o=n.nextSibling;e.parentNode.removeChild(n),n=o}}},{key:"setFieldValue",value:function(e,t){var r=this.fields.get(e);r.value=t,this.fields.set(e,r)}},{key:"render",value:function(e){if(!e||void 0===e.nodeType)throw new TypeError("container provided is not a Node","tnode.js");var t=Path.findNode(this.path,e);this.isAttr?this._renderAttr(t):this.isInterpolation&&this._renderInter(t)}},{key:"hasTNodeFields",get:function(){return this._type!==TNodeType.EMPTY&&0!==this.fields.size}},{key:"isAttr",get:function(){return this._type===TNodeType.ATTRIBUTE}},{key:"isInterpolation",get:function(){return this._type===TNodeType.INTERPOLATION}}]),t}(),_pathDel$1=".",TValueType={RAW:"raw",REF:"ref"},TValue=function(){function r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(_classCallCheck(this,r),null!==e&&"string"!=typeof e)throw new TypeError("The reference must be an string.","tvalue.js");if(null===e&&null===t)throw new Error("At least one argument must be provided.","tvalue.js");this._path=null!==e?e.split(_pathDel$1):null,this._value=t,this._type=null!==this._path?TValueType.REF:TValueType.RAW}return _createClass(r,[{key:"equalPath",value:function(e){if(!this.isRef)throw new TypeError("Current TValue is not a reference.","tvalue.js");if(Array.isArray(e))return this.path===e.join(_pathDel$1);if("string"==typeof e)return this.path===e;throw new TypeError("The reference must be a string or an array.","tvalue.js")}},{key:"fromData",value:function(e){if(!this.isRef)throw new TypeError("The current TValue is not a reference.","tvalue.js");if(!e||"object"!==_typeof(e))throw new TypeError("Data provided is null or is not an object.","tvalue.js");if(0===Object.keys(e).length)throw new Error("Data provided is empty.","tvalue.js");for(var t=e,r=0;r<this._path.length;r++){var n=this._path[r];if(!Object.prototype.hasOwnProperty.call(t,n)||void 0===t[n])return;t=t[n]}return t}},{key:"value",get:function(){return this._value}},{key:"path",get:function(){return this._path.join(_pathDel$1)}},{key:"isRef",get:function(){return this._type===TValueType.REF}},{key:"isRaw",get:function(){return this._type===TValueType.RAW}}]),r}(),_slotIndexHint="index",_slotMarkGenerator="\x3c!--slot(index)--\x3e",Template=function(){function a(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(_classCallCheck(this,a),!e||void 0===e.raw)throw new TypeError("The first arguments must be a string literal parts","template.js");if(e.raw.some(function(e){return"string"!=typeof e}))throw new TypeError("The template parts must be strings","template.js");if(e.raw.length!==t.length+1)throw new Error("The number of data slots mismatches with the number of template parts.","template.js");this._template=document.createElement("template"),this._parts=_toConsumableArray(e.raw),this._tnodes=[],this._tslots={refs:[],raw:[]},this._data=t.map(function(e){return e instanceof TValue?e:new TValue(null,e)}),this._prepareTemplate()}return _createClass(a,[{key:"_prepareTemplate",value:function(){this._markTemplate(),this._extractTNodes(),this._extractTSlots()}},{key:"_markTemplate",value:function(){var n=this,o="";this._parts.forEach(function(e,t){var r=n._data[t]?a._encodeMark(t):"";o+=e+r}),this._template.innerHTML=o}},{key:"_extractTNodes",value:function(){for(var e=document.createNodeIterator(this._template.content,NodeFilter.SHOW_COMMENTS,function(e){return e.nodeType===Node.ELEMENT_NODE||e.nodeType===Node.COMMENT_NODE?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}),t=0;e.nextNode();){var r=new TNode(e.referenceNode);r.hasTNodeFields&&(t+=r.fields.size,this._tnodes.push(r))}if(this._data.length!==t)throw new Error("The number of data slots mismatches with the number of data values provided.","template.js")}},{key:"_extractTSlots",value:function(){var a=this;this._tnodes.forEach(function(o){o.fields.forEach(function(e,t){var r=a._data[t],n={index:t,tnode:o,tvalue:r};r.isRef?a._tslots.refs.push(n):a._tslots.raw.push(n)})})}},{key:"_getSlotValue",value:function(e,t){if(e.tvalue.isRef){if(!t||"object"!==_typeof(t))throw new TypeError("Data provided is null or is not an object.","template.js");return e.tvalue.fromData(t)}return e.tvalue.value}},{key:"update",value:function(t,r,e){var n=2<arguments.length&&void 0!==e?e:void 0;if(!t||void 0===t.nodeType)throw new TypeError("container provided is not a Node","template.js");if("string"!=typeof r||""===r)throw new TypeError("path provided is not valid string","template.js");if(void 0===n)throw new TypeError("no value provided","template.js");var o=[];this._tslots.refs.forEach(function(e){e.tvalue.equalPath(r)&&(e.tnode.setFieldValue(e.index,n),o.includes(e.tnode)||o.push(e.tnode))}),o.forEach(function(e){return e.render(t)})}},{key:"render",value:function(t,r){var n=this;if(!t||void 0===t.nodeType)throw new TypeError("container provided is not a Node","template.js");if(!r||"object"!==_typeof(r))throw new TypeError("Data provided is null or is not an object.","template.js");t.innerHTML+=this._template.innerHTML,this.tslots.forEach(function(e){var t=n._getSlotValue(e,r);e.tnode.setFieldValue(e.index,t)}),this._tnodes.forEach(function(e){return e.render(t)})}},{key:"tslots",get:function(){return[].concat(_toConsumableArray(this._tslots.raw),_toConsumableArray(this._tslots.refs))}}],[{key:"_encodeMark",value:function(e){if(isNaN(e))throw new TypeError("index must be a number","template.js");return _slotMarkGenerator.replace(_slotIndexHint,e)}}]),a}(),html=function(e){for(var t=arguments.length,r=new Array(1<t?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return new Template(e,r)},val=function(e){return new TValue(e[0])};exports.default=Template,exports.html=html,exports.val=val;
